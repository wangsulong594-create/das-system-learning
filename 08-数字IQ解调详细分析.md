# DAS系统硬件详细分析：第八部分 - 数字IQ解调

## 8. 数字IQ解调 (Digital IQ Demodulation)

### 8.1 原理回顾

在模拟域，我们已经通过90°光学混合器和平衡探测器得到了I和Q路的模拟信号。现在需要在数字域进行进一步处理。

**采样后的I/Q信号**：
$$I[n] = I_0 \cos[\phi(n) + \phi_0] + n_I[n]$$
$$Q[n] = I_0 \sin[\phi(n) + \phi_0] + n_Q[n]$$

其中：
- $I_0$ = 信号幅度
- $\phi(n)$ = 待测的相位信号
- $\phi_0$ = 初始相位偏差
- $n_I[n], n_Q[n]$ = 噪声

### 8.2 中频（IF）处理

如果ADC采样的是中频（IF - Intermediate Frequency）信号而不是基带信号，需要先进行 IF 到基带的转换。

#### 8.2.1 IF信号的数字下变频 (Digital Down-Conversion, DDC)

**中频信号**：
$$s_{IF}[n] = I_0 \cos(2\pi f_{IF} n/f_s + \phi(n)) + n[n]$$

其中 $f_{IF}$ 是中频。

**使用本地振荡器（LO）进行混频**：

生成本地DDS（Direct Digital Synthesis）信号：
$$\cos(2\pi f_{IF} n/f_s)$$
$$\sin(2\pi f_{IF} n/f_s)$$

**混频输出**：
$$I'[n] = s_{IF}[n] \times \cos(2\pi f_{IF} n/f_s)$$
$$Q'[n] = s_{IF}[n] \times \sin(2\pi f_{IF} n/f_s)$$

### 8.3 低通滤波（去除高频分量）

混频后的信号包含基带分量和 $2f_{IF}$ 的高频分量，需要用数字低通滤波器去除。

#### 8.3.1 FIR低通滤波器

**滤波方程**：
$$y[n] = \sum_{k=0}^{M-1} h[k] x[n-k]$$

其中 $h[k]$ 是滤波器系数，$M$ 是滤波器阶数。

**设计指标**：
- **截止频率**：$f_c = 0.1 \times f_{vibration,max}$
- **过渡带宽**：$\Delta f = 0.05 \times f_{vibration,max}$
- **最小衰减**：>60 dB

**对于100 Hz最高振动频率**：
- 截止频率：10 Hz
- 过渡带：0-5 Hz
- 滤波器阶数：$M = 3.1/(\Delta f / f_s) = 3.1 \times f_s / (0.05 \times 100) = 620 \times f_s$

如果 $f_s = 100$ MHz，则 $M \approx 62000$（非常高！）

#### 8.3.2 IIR低通滤波器（更高效）

**一阶IIR滤波器**：
$$y[n] = \alpha x[n] + (1-\alpha) y[n-1]$$

其中 $\alpha = 2\pi f_c / (f_s + 2\pi f_c)$

**优点**：
- 只需2个乘法和1个加法
- 实现简单，计算量小

**缺点**：
- 相位失真
- 非线性相位响应

**推荐**：使用高阶IIR（如5阶Butterworth）或FIR，取决于实时性要求。

### 8.4 相位提取 (Phase Extraction)

从I/Q信号提取相位的方法有多种。

#### 8.4.1 反正切方法 (Arctangent Method)

**最直接的方法**：
$$\phi[n] = \text{atan2}(Q[n], I[n])$$

其中 $\text{atan2}$ 是四象限反正切函数，输出范围 $(-\pi, \pi]$。

**优点**：
- 实现简单
- 对振幅变化不敏感

**缺点**：
- 输出只在 $(-\pi, \pi]$ 范围内
- 相邻两帧的相位可能有 $2\pi$ 跳变（需要解缠绕）
- 噪声高时，相位估计方差大

#### 8.4.2 改进的相位估计方法

**复数相位表示**：
$$z[n] = I[n] + j Q[n] = A[n] e^{j\phi[n]}$$

**幅度和相位**：
$$A[n] = \sqrt{I[n]^2 + Q[n]^2}$$
$$\phi[n] = \arg(z[n]) = \text{atan2}(Q[n], I[n])$$

**降噪处理**：

如果噪声较大，可以先进行平均：
$$z_{avg}[n] = \frac{1}{N_{avg}} \sum_{k=0}^{N_{avg}-1} z[n-k]$$
$$\phi[n] = \arg(z_{avg}[n])$$

### 8.5 相位估计的噪声分析

#### 8.5.1 Cramér-Rao界

相位估计的理论最小方差由Cramér-Rao界给出：

$$\text{var}(\hat{\phi}) \geq \frac{1}{2 \rho^2}$$

其中 $\rho = A / \sigma$ 是信噪比（$A$ 是信号幅度，$\sigma$ 是噪声标准差）。

**SNR定义**：
$$SNR = \frac{A^2}{2\sigma^2} = \frac{\rho^2}{2}$$

**相位标准差**：
$$\sigma_\phi = \sqrt{\frac{1}{2 \times SNR}} = \frac{1}{\sqrt{2 \times SNR}}$$

**示例**：SNR = 30 dB = 1000
$$\sigma_\phi = \frac{1}{\sqrt{2000}} \approx 0.022 \text{ rad} \approx 1.3°$$

#### 8.5.2 相位噪声与频率偏差

相邻两个采样点的相位差（频率偏差）为：

$$\Delta \phi[n] = \phi[n] - \phi[n-1]$$

在没有实际信号变化的情况下，这个差值就是噪声：

$$\text{var}(\Delta \phi) = 2 \times \text{var}(\phi)$$

这会导致相位展开时的错误。

### 8.6 DCO（数字受控振荡器）与锁相环

在某些高级系统中，使用数字锁相环（DPLL）来改进相位估计。

#### 8.6.1 数字锁相环原理

```
输入信号 ──→ [相位比较器] ──→ [环路滤波器] ──→ [DCO] ──→ 输出信号
                 ↑                            ↓
                 └────────────────────────────┘
```

**相位比较器**：计算输入和本地信号的相位差
$$\Delta \phi = \text{atan2}(Q, I)$$

**环路滤波器**：
$$\omega_n[n] = K_p \Delta\phi[n] + K_i \sum \Delta\phi[k]$$

其中 $K_p, K_i$ 是比例和积分增益。

**DCO**：产生频率可调的正弦波
$$\phi_{out}[n] = \phi_{out}[n-1] + \omega_n[n] / f_s$$

**优势**：
- 提高相位估计精度
- 自动频率跟踪
- 对频率偏差鲁棒

### 8.7 实现方案

#### 8.7.1 FPGA实现

**推荐方案**：使用FPGA实现实时数字信号处理

**主要模块**：
1. DDC（数字下变频）- 可选
2. FIR/IIR低通滤波
3. 相位提取（atan2 或 CORDIC算法）
4. 相位展开
5. 数据缓存和输出接口

**FPGA器件选择**：
- **Xilinx Zynq-7000**：集成ARM + FPGA，便于与软件交互
- **Altera/Intel Cyclone V**：成本较低，功耗较低
- **Xilinx Virtex UltraScale+**：高性能，用于大规模系统

#### 8.7.2 CPU/GPU方案

**优点**：
- 灵活性高
- 易于调试
- 支持复杂算法

**缺点**：
- 延迟较高
- 实时性可能不足

**推荐方案**：
- **Nvidia Jetson AGX Orin**：用于边缘计算
- **Intel i7/i9 + GPU**：用于离线处理

### 8.8 IQ解调的关键参数总结

| 参数 | 符号 | 单位 | 推荐值 | 说明 |
|-----|------|------|--------|------|
| 滤波器截止频率 | $f_c$ | Hz | 0.1×$f_{max}$ | 低于振动频率 |
| 滤波器阶数 | $M$ | - | 50-200 | IIR; FIR可更高 |
| 相位估计方差 | $\sigma_\phi$ | rad | <0.05 | 取决于SNR |
| 相位时间分辨率 | $\Delta t$ | ms | $1/f_s$ | 采样时间间隔 |
| 相位空间分辨率 | $\Delta z$ | m | 10 | 对应脉冲宽度 |
