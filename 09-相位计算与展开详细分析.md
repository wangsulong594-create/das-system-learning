# DAS系统硬件详细分析：第九部分 - 相位计算与展开

## 9. 相位计算 (Phase Calculation)

### 9.1 基本相位计算

从I/Q信号计算相位的方法已在上一部分介绍：

$$\phi[n] = \text{atan2}(Q[n], I[n])$$

这给出的相位范围是 $(-\pi, \pi]$。

### 9.2 相位的物理意义

在DAS系统中，相位变化与应变/振动直接相关。

#### 9.2.1 瑞利散射中的相位变化

当光纤受到应变 $\varepsilon$ 时，光的波数改变：

$$\Delta k = \frac{2\pi}{\lambda} \times p_e \times \varepsilon$$

其中 $p_e$ 是光弹常数（约 0.22 for 光纤）。

**相位变化**：
$$\Delta \phi = \Delta k \times L = \frac{2\pi p_e}{\lambda} \times L \times \varepsilon$$

对于 1550 nm 光纤，1 km 长度：
$$\Delta \phi = \frac{2\pi \times 0.22}{1550 \times 10^{-9}} \times 1000 \times \varepsilon \approx 892 \times \varepsilon \text{ rad/strain}$$

#### 9.2.2 应变灵敏度

**相位变化与应变的关系**：
$$\frac{d\phi}{d\varepsilon} = \frac{2\pi p_e L}{\lambda}$$

对于更一般的情况（考虑波导效应）：
$$\frac{d\phi}{d\varepsilon} \approx 2\pi \times (p_e + \rho) \times \frac{L}{\lambda}$$

其中 $\rho$ 是应变光学系数。

**典型值**：约 $1-2$ rad/μstrain（每微应变）

### 9.3 相位展开 (Phase Unwrapping)

#### 9.3.1 问题陈述

由于 atan2 函数的周期性，相位信息被限制在 $(-\pi, \pi]$ 范围内。当真实相位超过这个范围时，会产生 $2\pi$ 的不连续跳变：

**例子**：
```
真实相位：... -3π/2, -π, -π/2, 0, π/2, π, 3π/2, 2π, 5π/2, ...
包裹相位：... π/2, π, -π/2, 0, π/2, π, -π/2, 0, π/2, ...
```

相位展开的目标是恢复真实的连续相位曲线。

#### 9.3.2 一维相位展开（沿时间或空间）

**简单差分法**（Path Following Algorithm）：

```python
def unwrap_phase(phi_wrapped):
    """
    phi_wrapped: 包裹的相位（range: -π to π）
    返回：展开的相位
    """
    phi_unwrapped = np.zeros_like(phi_wrapped)
    phi_unwrapped[0] = phi_wrapped[0]
    
    for n in range(1, len(phi_wrapped)):
        dphi = phi_wrapped[n] - phi_wrapped[n-1]
        
        # 如果相位跳变超过π，说明发生了2π的跳变
        if dphi > np.pi:
            dphi = dphi - 2*np.pi
        elif dphi < -np.pi:
            dphi = dphi + 2*np.pi
        
        phi_unwrapped[n] = phi_unwrapped[n-1] + dphi
    
    return phi_unwrapped
```

**原理**：
- 计算相邻两点的相位差：$\Delta\phi = \phi[n] - \phi[n-1]$
- 如果 $\Delta\phi > \pi$，减去 $2\pi$
- 如果 $\Delta\phi < -\pi$，加上 $2\pi$
- 累加得到展开相位

**优点**：
- 简单快速
- 计算量小

**缺点**：
- 对噪声敏感
- 一个错误会累积到后续所有点

#### 9.3.3 带通滤波相位展开

为了提高鲁棒性，可以先对相位进行带通滤波，去除高频噪声。

**步骤**：
1. 设计带通滤波器，通带为信号的实际频率范围
2. 对包裹相位进行滤波
3. 再进行展开

**带通滤波器设计**：
- 下截止频率：$f_{low} = 0.5 \times f_{min}$（最低信号频率）
- 上截止频率：$f_{high} = 2 \times f_{max}$（最高信号频率）

对于 0.1-100 Hz 的地震信号：
- $f_{low} = 0.05$ Hz
- $f_{high} = 200$ Hz

#### 9.3.4 二维相位展开（空间+时间）

在DAS系统中，通常有空间（沿光纤）和时间两个维度的相位数据：

$$\phi(z, t)$$

**二维展开方法**：

**质量引导法（Quality-Guided Phase Unwrapping）**：

1. 计算相位质量函数（基于梯度的一致性）：
$$Q(z, t) = \frac{1}{1 + |\nabla \phi(z,t)|}$$

2. 按质量从高到低展开
3. 对于高质量点，优先展开
4. 低质量点沿着高质量点展开

**优势**：
- 对噪声鲁棒
- 能处理相位不连续

#### 9.3.5 相位跳变检测

在展开前，可以检测是否存在真实的相位跳变（如缠绕线圈）。

**方法**：检查一阶和二阶差分

```python
def detect_phase_wraps(phi_wrapped):
    """检测相位包裹点"""
    wraps = np.diff(phi_wrapped) > np.pi
    return np.where(wraps)[0]
```

### 9.4 相位去趋势 (Detrending)

展开后的相位可能包含低频趋势，需要去除以获得振动信号。

#### 9.4.1 最小二乘拟合去趋势

**线性趋势**：
$$\phi_{trend}(t) = a \cdot t + b$$

使用最小二乘法拟合：
$$[a, b]^T = (X^T X)^{-1} X^T \phi(t)$$

其中 $X = [t, 1]^T$

**去趋势相位**：
$$\phi_{detrended}(t) = \phi(t) - \phi_{trend}(t)$$

#### 9.4.2 高阶多项式去趋势

对于非线性趋势，使用高阶多项式：

$$\phi_{trend}(t) = \sum_{k=0}^{M} a_k t^k$$

通常 M = 3 or 5 足够。

#### 9.4.3 HP滤波（Hodrick-Prescott Filter）

一种更高级的去趋势方法，平衡拟合和平滑：

$$\min \sum_{t=1}^T (\phi(t) - \phi_{trend}(t))^2 + \lambda \sum_{t=2}^{T-1} (\Delta^2 \phi_{trend}(t))^2$$

其中 $\lambda$ 是平滑参数，$\Delta^2$ 是二阶差分。

**优点**：
- 自动平衡拟合和平滑
- 保留高频信号

### 9.5 相位滤波与去噪

#### 9.5.1 中值滤波

对于脉冲噪声，中值滤波效果好：

$$\phi_{filtered}[n] = \text{median}(\phi[n-w:n+w])$$

其中 $w$ 是窗口半径。

**优点**：
- 去除脉冲噪声
- 保留边界
- 非线性，对大幅值跳变不敏感

#### 9.5.2 卡尔曼滤波（用于实时处理）

状态空间模型：
$$\phi[n] = \phi[n-1] + v[n]$$
$$z[n] = \phi[n] + w[n]$$

其中 $v[n]$ 是过程噪声，$w[n]$ 是测量噪声。

**卡尔曼增益**：
$$K[n] = \frac{P[n|n-1]}{P[n|n-1] + R}$$

**更新方程**：
$$\hat{\phi}[n|n] = \hat{\phi}[n|n-1] + K[n](z[n] - \hat{\phi}[n|n-1])$$

**优点**：
- 实时处理
- 最优性能
- 计算量小

### 9.6 相位标定 (Phase Calibration)

系统中存在初始相位偏差和漂移，需要标定。

#### 9.6.1 初始相位偏差

$$\phi_{measured}[n] = \phi_{true}[n] + \phi_{offset}$$

**标定方法**：
- 在无信号条件下，多次测量相位
- 取平均值作为偏差

$$\phi_{offset} = \text{mean}(\phi[n]|_{no\_signal})$$

#### 9.6.2 温度漂移

光纤相位对温度敏感：

$$\frac{d\phi}{dT} \approx 1-2 \text{ rad/°C}$$

**补偿方法**：
1. 用温度传感器测量光纤温度
2. 在处理中减去温度引入的相位变化

$$\phi_{corrected} = \phi_{measured} - \alpha(T - T_0)$$

其中 $\alpha \approx 1$ rad/°C

#### 9.6.3 相位参考点

在长光纤中，可以选择参考点（无振动的点）进行标定。

---

## 总结表

| 参数 | 符号 | 单位 | 推荐值 | 说明 |
|-----|------|------|--------|------|
| 相位范围 | $\phi$ | rad | $(-\pi, \pi]$ | atan2输出 |
| 相位灵敏度 | $\frac{d\phi}{d\varepsilon}$ | rad/strain | 1-2 | 应变灵敏度 |
| 展开窗口 | - | points | 100-1000 | 一维展开长度 |
| 去趋势多项式阶数 | M | - | 3-5 | 多项式拟合 |
| 中值滤波窗口 | $2w+1$ | points | 3-7 | 脉冲去噪 |
| 卡尔曼增益 | $K$ | - | 0.1-0.5 | 实时滤波 |
| 温度漂移系数 | $\alpha$ | rad/°C | 1-2 | 温度补偿 |
